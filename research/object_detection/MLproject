name: CV Object Detection

conda_env: conda.yml

entry_points:
  main:
    parameters:
      pipeline: path
      # MLflow doesn't support bools or flags. Python will handle parsing.
      restore_box_predictors: {type: string, default: "False"}
      resume_global_step: {type: string, default: "False"}
      train_dir: path
      eval_dir: path
      force_fewer_eval_examples: {type: string, default: "False"}
      max_gpu_memfrac: {type: float, default: 1.0}
      train_cuda_visible_devices: {type: string, default: "UNSET"}
      eval_cuda_visible_devices: {type: string, default: "UNSET"}
    command: >
      pip install -e ../cv-object-detection/ &&
      python ../main.py train_and_evaluate
      {pipeline}
      --restore-box-predictors {restore_box_predictors}
      --resume-global-step {resume_global_step}
      --train-dir {train_dir}
      --eval-dir {eval_dir}
      --force-fewer-eval-examples {force_fewer_eval_examples}
      --max-gpu-memfrac {max_gpu_memfrac}
      --train-cuda-visible-devices {train_cuda_visible_devices}
      --eval-cuda-visible-devices {eval_cuda_visible_devices}

  train:
    parameters:
      pipeline: path
      restore_box_predictors: {type: string, default: "False"}
      resume_global_step: {type: string, default: "False"}
      train_dir: path
    command: >
      pip install -e ../cv-object-detection/ &&
      python ../main.py train
      {pipeline}
      --restore-box-predictors {restore_box_predictors}
      --resume-global-step {resume_global_step}
      --train-dir {train_dir}

  evaluate:
    parameters:
      pipeline: path
      checkpoint_dir: path
      eval_dir: path
      force_fewer_eval_examples: {type: string, default: "False"}
      max_gpu_memfrac: {type: float, default: 1.0}
    command: >
      pip install -e ../cv-object-detection/ &&
      python ../main.py evaluate
      {pipeline} {checkpoint_dir}
      --eval-dir {eval_dir}
      --force-fewer-eval-examples {force_fewer_eval_examples}
      --max-gpu-memfrac {max_gpu_memfrac}

  test:
    command: pytest ../ --ignore=../cv-object-detection
